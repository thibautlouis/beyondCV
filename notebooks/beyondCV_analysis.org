#+TITLE: Beyond Cosmic Variance Analysis

* Preamble
#+BEGIN_SRC ipython :session bcv :results none
  %matplotlib inline
  import matplotlib.pyplot as plt
  plt.rcParams["text.usetex"] = True
  import pandas as pd
  import numpy as np
  from getdist import plots, MCSamples
  from IPython.display import HTML, display
  import tabulate
#+END_SRC

* Check minimization algorithm
Parse =qsub= output files
#+BEGIN_SRC ipython :session bcv :results none
  import os, glob

  path =r"/home/garrido/Workdir/CMB/analysis/beyondCV/script/"
  all_files = glob.glob(os.path.join(path, "*.o*"))

  chi2_theory = []
  chi2_begin  = []
  chi2_end    = []
  success     = []
  surveys     = []
  start_time  = []
  stop_time   = []
  seeds       = []

  def date2time(line):
      time = line.split(" ", maxsplit=3)[-1]
      time = time[:-5].strip()
      return pd.to_datetime(time, format="%c")

  for f in all_files:
      find_begin = False
      success += [False]
      chi2_end += [0]
      with open(f) as stream:
          for line in stream:
              if "DEBUG: seed" in line:
                  seeds += [line.split("=")[1].strip()]
              if "DEBUG: survey" in line:
                  survey = line.split("=")[1].strip()
                  if survey == "SO" or survey == "P":
                    survey += "x" + survey
                  surveys += [survey]
              if "chi2(theo)/ndf" in line:
                  if survey in line:
                      chi2_theory += [float(line.split("=")[1].strip())]
              if "chi2/ndf" in line:
                  if not find_begin:
                      chi2_begin += [float(line.split("=")[1].strip())]
                      find_begin = True
                  chi2_end[-1] = float(line.split("=")[1].strip())
              if "Finished succesfully." in line:
                  success[-1] = True
              if "Started on" in line:
                  start_time += [date2time(line)]
              if "Ended on" in line:
                  stop_time += [date2time(line)]
  print("INFO: Read {} files".format(len(all_files)))
#+END_SRC

Convert =list= into =pandas.DataFrame=
#+BEGIN_SRC ipython :session bcv :results drawer
  df = pd.DataFrame({"duration": np.array(stop_time)-np.array(start_time),
                     "chi2_theory": chi2_theory,
                     "chi2_begin": chi2_begin,
                     "chi2_end": chi2_end,
                     "success": success,
                     "survey": surveys},
                    index=np.array(seeds, dtype=np.uint))
  df.sort_index(inplace=True)
  df.head()
#+END_SRC

#+RESULTS:
:results:
# Out[190]:
#+BEGIN_EXAMPLE
  duration  chi2_theory  chi2_begin  chi2_end  success survey
  0 00:35:53     0.960852    1.775541  0.956156    False   SOxP
  0 00:33:56     0.961740    1.783959  0.957032     True  SOxSO
  0 00:49:48     0.957421    1.727541  0.952406    False    PxP
  1 01:06:20     0.994213    1.736074  0.987232    False  SOxSO
  1 00:44:47     0.985661    1.708013  0.978956    False   SOxP
#+END_EXAMPLE
:end:

Get duration statistics
#+BEGIN_SRC ipython :session bcv :results drawer
  df.duration.describe()
#+END_SRC

#+RESULTS:
:results:
# Out[191]:
#+BEGIN_EXAMPLE
  count                      3001
  mean     0 days 00:33:47.026324
  std      0 days 00:13:20.746408
  min             0 days 00:06:14
  25%             0 days 00:23:42
  50%             0 days 00:32:31
  75%             0 days 00:41:59
  max             0 days 02:42:29
  Name: duration, dtype: object
#+END_EXAMPLE
:end:

Get number of sucessful minimization
#+BEGIN_SRC ipython :session bcv :results drawer
  np.sum(df.success)
#+END_SRC

#+RESULTS:
:results:
# Out[192]:
: 2009
:end:

How many minimizations succeed for the three configurations /i.e./ SOxSO, SOxP, PxP
#+BEGIN_SRC ipython :session bcv :results drawer
  dff = df.groupby(df.index).success.describe()
  np.sum((dff.top == True) & (dff.freq == 3)), \
  np.sum((dff.top == False) & (dff.freq == 3))
#+END_SRC

#+RESULTS:
:results:
# Out[174]:
: (252, 51)
:end:

** Plot distribution of $\chi^2$ between successfull and unsuccessful minimizations
#+BEGIN_SRC ipython :session bcv :results none
  import seaborn as sb
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  tmpl="{}\n$\chi^2$ = {:.3f} $\pm$ {:.3f}"
  df1 = df.chi2_theory[df.success]
  df2 = df.chi2_theory[~df.success]
  sb.distplot(df1, label=tmpl.format("sucessfull",np.mean(df1),np.std(df1)), color="green", axlabel=r"$\chi^2$ (theory)")
  sb.distplot(df2, label=tmpl.format("unsuccessful",np.mean(df2), np.std(df2)), color="red", axlabel=r"$\chi^2$ (theory)")
  plt.legend()
#+END_SRC

#+RESULTS:
:results:
# Out[195]:
: <matplotlib.legend.Legend at 0x7f1edac23c18>
[[file:./obipy-resources/Xw58n6.png]]
:end:

#+BEGIN_SRC ipython :session bcv :results raw drawer
  tmpl="{}\n$\chi^2$ = {:.3f} $\pm$ {:.3f}"
  df1 = df.chi2_begin[df.success]
  df2 = df.chi2_begin[~df.success]
  sb.distplot(df1, label=tmpl.format("sucessfull",np.mean(df1),np.std(df1)), color="green", axlabel=r"$\chi^2$ (begin)")
  sb.distplot(df2, label=tmpl.format("unsuccessful",np.mean(df2),np.std(df2)), color="red", axlabel=r"$\chi^2$ (begin)")
  plt.legend()
#+END_SRC

#+RESULTS:
:results:
# Out[196]:
: <matplotlib.legend.Legend at 0x7f1edad5cc18>
[[file:./obipy-resources/LoePO5.png]]
:end:

#+BEGIN_SRC ipython :session bcv :results raw drawer
  tmpl="{}\n$\chi^2$ = {:.3f} $\pm$ {:.3f}"
  df1 = df.chi2_end[df.success]
  df2 = df.chi2_end[~df.success]
  sb.distplot(df1, label=tmpl.format("sucessfull",np.mean(df1),np.std(df1)), color="green", axlabel=r"$\chi^2$ (found)")
  sb.distplot(df2, label=tmpl.format("unsuccessful",np.mean(df2),np.std(df2)), color="red", axlabel=r"$\chi^2$ (found)")
  plt.legend()
#+END_SRC

#+RESULTS:
:results:
# Out[197]:
: <matplotlib.legend.Legend at 0x7f1edaaa83c8>
[[file:./obipy-resources/sbbPH3.png]]
:end:

* Plot cosmological parameters distribution
** Cosmo. parameters LaTeX labels
#+BEGIN_SRC ipython :session bcv :results none
  labels = [r"$\theta_\mathrm{MC}$",
            r"$A_\mathrm{s}$",
            r"$n_\mathrm{s}$",
            r"$\Omega_\mathrm{b}h^2$",
            r"$\Omega_\mathrm{c}h^2$",
            r"$\chi^2/\mathrm{ndf}$"]
#+END_SRC

** Get cosmo. parameters from output file
#+BEGIN_SRC ipython :session bcv :results none
  def get_params(path, pattern="*.likelihood"):
      import os, glob
      all_files = glob.glob(os.path.join(path, pattern))
      # Sort alphabetically
      all_files.sort()

      header = pd.read_csv(all_files[0], delim_whitespace=True).columns[1:]
      df = pd.concat((pd.read_table(f, delim_whitespace=True) for f in all_files))

      # Remove '#' in header
      df.drop(df.columns[[-1,]], axis=1, inplace=True)
      df.columns = header
      df.insert(value=df.chi2/2/1944, column="chi2_ndf", loc=7)
      params = np.array(df.iloc[:, 2:8])
      return params
#+END_SRC

** Show input values of cosmo. parameters
#+BEGIN_SRC ipython :session bcv :results none
  ref = [1.04164/100, np.exp(3.058)/1e10, 0.9649, 0.02212, 0.1210]
  def show_ref(g):
      for i, r in enumerate(ref):
          kwargs = dict(color="gray", ls="--", lw=1)
          for ax in g.subplots[:,i]:
              if ax: ax.axvline(r, **kwargs)
          for ax in g.subplots[i,:i]:
              if ax: ax.axhline(r, **kwargs)
#+END_SRC
** Results from pure Planck simulation
*** Cosmo. parameters distribution
#+BEGIN_SRC ipython :session bcv :results none
  params = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/unbinned")
  samples = MCSamples(samples=params, names=labels)
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  g = plots.getSubplotPlotter()
  g.settings.colormap = "inferno"
  g.triangle_plot(samples, params=labels[:-1], shaded=True)
  show_ref(g)
#+END_SRC

#+RESULTS:
:results:
# Out[6]:
[[file:./obipy-resources/udD6Jr.png]]
:end:

#+BEGIN_SRC ipython :session bcv :results raw drawer
  g = plots.getSubplotPlotter()
  g.settings.colormap_scatter = "inferno"
  g.triangle_plot(samples, params=labels[:-1],
                  plot_3d_with_param="$\chi^2/\mathrm{ndf}$", scatter_size=20)
  show_ref(g)
#+END_SRC

#+RESULTS:
:results:
# Out[7]:
[[file:./obipy-resources/IIe6N6.png]]
:end:

#+BEGIN_SRC ipython :session bcv :results output
  print("Number of sucessful minimization :", np.alen(params))
#+END_SRC

#+RESULTS:
: Number of sucessful minimization : 638

#+BEGIN_SRC ipython :session bcv :results none
  min_mean = np.mean(params, axis=0)
  min_std  = np.std(params, axis=0)
  fisher = np.array([5.1265507267143515e-06, 1.2854648947626772e-11, 0.005589724100405197, 0.00020382255228959767, 0.002334040314343261, 1.])
  lines = [[r"$\mu$"], [r"$\sigma$"], [r"$\sigma$ (Fisher)"], [r"$\Delta\sigma$ (min-Fisher) [%]"]]
  table = np.stack([min_mean, min_std, fisher, 100*(min_std-fisher)/fisher])
  table = np.append(lines, table, axis=1)
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  display(HTML(tabulate.tabulate(table, headers=labels, tablefmt="html")))
#+END_SRC

#+RESULTS:
:results:
# Out[17]:
: <IPython.core.display.HTML object>
:end:

*** =Org= table                                                  :noexport:

#+BEGIN_SRC ipython :session bcv :results raw output :export none
  print(tabulate.tabulate(table, headers=labels, tablefmt="orgtbl"))
#+END_SRC

#+RESULTS:
|                                 | $\theta_\mathrm{MC}$ | $A_\mathrm{s}$ | $n_\mathrm{s}$ | $\Omega_\mathrm{b}h^2$ | $\Omega_\mathrm{c}h^2$ | $\chi^2/\mathrm{ndf}$ |
|---------------------------------+----------------------+----------------+----------------+------------------------+------------------------+-----------------------|
| $\mu$                           |            0.0104162 |    2.12887e-09 |       0.964695 |              0.0221223 |                0.12108 |               1.53808 |
| $\sigma$                        |          4.99937e-06 |    1.24047e-11 |     0.00544548 |            0.000206822 |              0.0022281 |               0.03946 |
| $\sigma$ (Fisher)               |          5.12655e-06 |    1.28546e-11 |     0.00558972 |            0.000203823 |             0.00233404 |                     1 |
| $\Delta\sigma$ (min-Fisher) [%] |             -2.48081 |        -3.5002 |       -2.58047 |                1.47141 |                -4.5391 |               -96.054 |

** Results from 100 simulations
Simulations are all the same (seed is 31415) and we estimate the intrinsic variance on
cosmo. parameters /i.e./ the systematics from minimization.

#+BEGIN_SRC ipython :session bcv :results none
  params = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/100_sims_syst")
  samples = MCSamples(samples=params, names=labels)
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  g = plots.getSubplotPlotter()
  g.settings.colormap_scatter = "inferno"
  g.triangle_plot(samples, params=labels[:-1],
                  plot_3d_with_param="$\chi^2/\mathrm{ndf}$", scatter_size=20)
  show_ref(g)
#+END_SRC

#+RESULTS:
:results:
# Out[38]:
[[file:./obipy-resources/AJvxQD.png]]
:end:

#+BEGIN_SRC ipython :session bcv :results none
  min_mean = np.mean(params, axis=0)
  min_std  = np.std(params, axis=0)
  lines = [[r"$\mu$"], [r"$\sigma$"]]
  table = np.stack([min_mean, min_std])
  table = np.append(lines, table, axis=1)
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  display(HTML(tabulate.tabulate(table, headers=labels, tablefmt="html")))
#+END_SRC

#+RESULTS:
:results:
# Out[63]:
: <IPython.core.display.HTML object>
:end:

#+BEGIN_SRC ipython :session bcv :results raw output
  print(tabulate.tabulate(table, headers=labels, tablefmt="orgtbl"))
#+END_SRC

#+RESULTS:
|          | $\theta_\mathrm{MC}$ | $A_\mathrm{s}$ | $n_\mathrm{s}$ | $\Omega_\mathrm{b}h^2$ | $\Omega_\mathrm{c}h^2$ | $\chi^2/\mathrm{ndf}$ |
|----------+----------------------+----------------+----------------+------------------------+------------------------+-----------------------|
| $\mu$    |            0.0104275 |    2.10469e-09 |       0.975453 |              0.0224105 |               0.116425 |              0.975523 |
| $\sigma$ |          8.08209e-08 |    3.69492e-13 |    0.000129202 |            6.52134e-06 |            7.14235e-05 |           3.21921e-06 |

* Simons Observatory ⊗ Planck
** \ell \in [2; 3000]
#+BEGIN_SRC ipython :session bcv :results raw drawer
  params_SO   = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/ell_2_3000", "*SO.likelihood")
  params_SOxP = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/ell_2_3000", "*SOxP.likelihood")
  params_P    = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/ell_2_3000", "*_P.likelihood")
  params_SO.shape, params_SOxP.shape, params_P.shape
#+END_SRC

#+RESULTS:
:results:
# Out[175]:
: ((978, 6), (978, 6), (978, 6))
:end:

#+BEGIN_SRC ipython :session bcv :results none
  samples_SO   = MCSamples(samples=params_SO, names=labels, label="SOxSO")
  samples_SOxP = MCSamples(samples=params_SOxP, names=labels, label="SOxP")
  samples_P    = MCSamples(samples=params_P, names=labels, label="PxP")
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results none
  lines = [[r"$\mu$(SOxSO)"], [r"$\mu$(SOxP)"], [r"$\mu$(PxP)"],
           [r"$\sigma$(SOxSO)"], [r"$\sigma$(SOxP)"], [r"$\sigma$(PxP)"],
           [r"$\sigma$(SOxSO - PxP)"], [r"$\sigma$(SOxSO - SOxP)"], [r"$\sigma$(SOxSO + PxP - 2 SOxP)"]]
  std_SO, std_SOxP, std_P = np.std(params_SO, axis=0), np.std(params_SOxP, axis=0), np.std(params_P, axis=0)
  std_SOmP = np.std(params_SO-params_P, axis=0)
  std_SOmSOxP = np.std(params_SO-params_SOxP, axis=0)
  std_SOpPm2SOxP = np.std(params_SO + params_P - 2*params_SOxP, axis=0)
  table = np.stack([np.mean(params_SO, axis=0),
                    np.mean(params_SOxP, axis=0),
                    np.mean(params_P, axis=0),
                    std_SO, std_SOxP, std_P,
                    std_SOmP, std_SOmSOxP, std_SOpPm2SOxP
  ])
  table = np.append(lines, table, axis=1)
  display(HTML(tabulate.tabulate(table, headers=labels, tablefmt="html")))
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  x = np.arange(5)
  plt.plot(x, 100*(1-std_P/std_SO)[:-1], "o", label="P")
  plt.plot(x, 100*(1-std_SOxP/std_SO)[:-1], "o", label="SOxP")
  plt.plot(x, 100*(1-std_SOmP/std_SO)[:-1], "o", label="SO-P")
  plt.plot(x, 100*(1-std_SOmSOxP/std_SO)[:-1], "o", label="SO-SOxP")
  plt.plot(x, 100*(1-std_SOpPm2SOxP/std_SO)[:-1], "o", label="SO+P-2SOxP")
  plt.xticks(x, labels[:-1])
  plt.ylabel(r"$\Delta_{\mathrm{/SO}}$ [\%]")
  plt.legend(loc="upper left", title=r"$\ell\in[2; 3000]$", bbox_to_anchor=(1,1))
#+END_SRC

#+RESULTS:
:results:
# Out[96]:
: <matplotlib.legend.Legend at 0x7f1ed6aa0d68>
[[file:./obipy-resources/5YM65u.png]]
:end:

*** Org table                                                    :noexport:
#+BEGIN_SRC ipython :session bcv :results raw output
  print(tabulate.tabulate(table, headers=labels, tablefmt="orgtbl"))
#+END_SRC

#+RESULTS:
|                                | $\theta_\mathrm{MC}$ | $A_\mathrm{s}$ | $n_\mathrm{s}$ | $\Omega_\mathrm{b}h^2$ | $\Omega_\mathrm{c}h^2$ | $\chi^2/\mathrm{ndf}$ |
|--------------------------------+----------------------+----------------+----------------+------------------------+------------------------+-----------------------|
| $\mu$(SOxSO)                   |            0.0104163 |     2.1288e-09 |       0.964831 |              0.0221165 |               0.121037 |               1.53776 |
| $\mu$(SOxP)                    |            0.0104162 |    2.12874e-09 |       0.964837 |              0.0221241 |               0.121029 |               1.53979 |
| $\mu$(PxP)                     |            0.0104161 |    2.12891e-09 |       0.964766 |              0.0221283 |               0.121065 |               1.53859 |
| $\sigma$(SOxSO)                |          3.30158e-06 |    8.82142e-12 |     0.00403527 |            0.000113061 |             0.00147556 |             0.0399001 |
| $\sigma$(SOxP)                 |          4.13856e-06 |    1.10042e-11 |      0.0048009 |            0.000153239 |             0.00196259 |             0.0401134 |
| $\sigma$(PxP)                  |          4.88563e-06 |    1.22407e-11 |     0.00529792 |            0.000204028 |              0.0022389 |             0.0384675 |
| $\sigma$(SOxSO - PxP)          |          3.76192e-06 |    9.58206e-12 |     0.00406034 |            0.000171957 |             0.00181588 |             0.0381408 |
| $\sigma$(SOxSO - SOxP)         |          2.53148e-06 |    7.13821e-12 |     0.00291831 |            0.000104709 |             0.00135525 |             0.0323524 |
| $\sigma$(SOxSO + PxP - 2 SOxP) |          3.28542e-06 |    9.16644e-12 |     0.00375188 |            0.000160698 |             0.00174672 |             0.0537651 |

** \ell \in [50; 2000]
#+BEGIN_SRC ipython :session bcv :results raw drawer
  params_SO   = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/ell_50_2000", "*SO.likelihood")
  params_SOxP = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/ell_50_2000", "*SOxP.likelihood")
  params_P    = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/ell_50_2000", "*_P.likelihood")
  params_SO.shape, params_SOxP.shape, params_P.shape
#+END_SRC

#+RESULTS:
:results:
# Out[210]:
: ((971, 6), (971, 6), (971, 6))
:end:

#+BEGIN_SRC ipython :session bcv :results none
  samples_SO   = MCSamples(samples=params_SO, names=labels, label="SOxSO")
  samples_SOxP = MCSamples(samples=params_SOxP, names=labels, label="SOxP")
  samples_P    = MCSamples(samples=params_P, names=labels, label="PxP")
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  g = plots.getSubplotPlotter()
  g.triangle_plot([samples_SO, samples_SOxP, samples_P], params=labels[:-1])
  show_ref(g)
#+END_SRC

#+RESULTS:
:results:
# Out[178]:
[[file:./obipy-resources/j0LRmj.png]]
:end:

#+BEGIN_SRC ipython :session bcv :results none
  lines = [[r"$\mu$(SOxSO)"], [r"$\mu$(SOxP)"], [r"$\mu$(PxP)"],
           [r"$\sigma$(SOxSO)"], [r"$\sigma$(SOxP)"], [r"$\sigma$(PxP)"],
           [r"$\sigma$(SOxSO - PxP)"], [r"$\sigma$(SOxSO - SOxP)"], [r"$\sigma$(SOxSO + PxP - 2 SOxP)"]]
  std_SO, std_SOxP, std_P = np.std(params_SO, axis=0), np.std(params_SOxP, axis=0), np.std(params_P, axis=0)
  std_SOmP = np.std(params_SO-params_P, axis=0)
  std_SOmSOxP = np.std(params_SO-params_SOxP, axis=0)
  std_SOpPm2SOxP = np.std(params_SO + params_P - 2*params_SOxP, axis=0)
  table = np.stack([np.mean(params_SO, axis=0),
                    np.mean(params_SOxP, axis=0),
                    np.mean(params_P, axis=0),
                    std_SO, std_SOxP, std_P,
                    std_SOmP, std_SOmSOxP, std_SOpPm2SOxP
  ])
  table = np.append(lines, table, axis=1)
  display(HTML(tabulate.tabulate(table, headers=labels, tablefmt="html")))
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  x = np.arange(5)
  plt.plot(x, 100*(1-std_P/std_SO)[:-1], "o", label="P")
  plt.plot(x, 100*(1-std_SOxP/std_SO)[:-1], "o", label="SOxP")
  plt.plot(x, 100*(1-std_SOmP/std_SO)[:-1], "o", label="SO-P")
  plt.plot(x, 100*(1-std_SOmSOxP/std_SO)[:-1], "o", label="SO-SOxP")
  plt.plot(x, 100*(1-std_SOpPm2SOxP/std_SO)[:-1], "o", label="SO+P-2SOxP")
  plt.ylabel(r"$\Delta_{\mathrm{/SO}}$ [\%]")
  plt.xticks(x, labels[:-1])
  plt.legend(loc="upper left", title=r"$\ell\in[50; 2000]$", bbox_to_anchor=(1,1))
#+END_SRC

#+RESULTS:
:results:
# Out[212]:
: <matplotlib.legend.Legend at 0x7f1eda594ac8>
[[file:./obipy-resources/bvGysh.png]]
:end:

*** Org table                                                    :noexport:
#+BEGIN_SRC ipython :session bcv :results raw output
  print(tabulate.tabulate(table, headers=labels, tablefmt="orgtbl"))
#+END_SRC

#+RESULTS:
|                               | $\theta_\mathrm{MC}$ | $A_\mathrm{s}$ | $n_\mathrm{s}$ | $\Omega_\mathrm{b}h^2$ | $\Omega_\mathrm{c}h^2$ | $\chi^2/\mathrm{ndf}$ |
|-------------------------------+----------------------+----------------+----------------+------------------------+------------------------+-----------------------|
| $\mu$(SOxSO)                  |            0.0104165 |    2.12888e-09 |       0.964796 |               0.022119 |               0.121061 |               1.00019 |
| $\mu$(SOxP)                   |            0.0104165 |    2.12863e-09 |       0.964918 |              0.0221197 |               0.121011 |               1.00034 |
| $\mu$(PxP)                    |            0.0104164 |    2.12876e-09 |       0.964918 |               0.022122 |               0.121043 |               1.00003 |
| $\sigma$(SOxSO)               |          4.35923e-06 |    1.19063e-11 |     0.00529269 |            0.000197395 |             0.00208537 |             0.0319118 |
| $\sigma$(SOxP)                |          4.70511e-06 |    1.28073e-11 |     0.00574473 |            0.000196329 |             0.00236035 |             0.0321642 |
| $\sigma$(PxP)                 |          5.16462e-06 |    1.32325e-11 |     0.00592473 |            0.000214703 |             0.00238011 |             0.0327516 |
| $\sigma$(SOxSO - PxP)         |          2.99731e-06 |    7.16794e-12 |     0.00314853 |            0.000122405 |             0.00133315 |             0.0201569 |
| $\sigma$(SOxSO - SOxP)        |          2.03202e-06 |    5.97189e-12 |     0.00261404 |            8.41646e-05 |             0.00127252 |             0.0126795 |
| $\sigma$(SOxSO + PxP - 2 SOxP |          3.05013e-06 |    9.43821e-12 |     0.00429037 |            0.000118191 |             0.00217506 |             0.0185606 |


** \ell \in [50; 1500]
#+BEGIN_SRC ipython :session bcv :results raw drawer
  params_SO   = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/ell_50_1500", "*SO.likelihood")
  params_SOxP = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/ell_50_1500", "*SOxP.likelihood")
  params_P    = get_params(r"/home/garrido/Workdir/CMB/analysis/beyondCV/output/ell_50_1500", "*_P.likelihood")
  params_SO.shape, params_SOxP.shape, params_P.shape
#+END_SRC

#+RESULTS:
:results:
# Out[214]:
: ((999, 6), (999, 6), (999, 6))
:end:

#+BEGIN_SRC ipython :session bcv :results none
  samples_SO   = MCSamples(samples=params_SO, names=labels, label="SOxSO")
  samples_SOxP = MCSamples(samples=params_SOxP, names=labels, label="SOxP")
  samples_P    = MCSamples(samples=params_P, names=labels, label="PxP")
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  g = plots.getSubplotPlotter()
  g.triangle_plot([samples_SO, samples_SOxP, samples_P], params=labels[:-1])
  show_ref(g)
#+END_SRC

#+RESULTS:
:results:
# Out[206]:
[[file:./obipy-resources/O4TXAu.png]]
:end:

#+BEGIN_SRC ipython :session bcv :results none
  lines = [[r"$\mu$(SOxSO)"], [r"$\mu$(SOxP)"], [r"$\mu$(PxP)"],
           [r"$\sigma$(SOxSO)"], [r"$\sigma$(SOxP)"], [r"$\sigma$(PxP)"],
           [r"$\sigma$(SOxSO - PxP)"], [r"$\sigma$(SOxSO - SOxP)"], [r"$\sigma$(SOxSO + PxP - 2 SOxP)"]]
  std_SO, std_SOxP, std_P = np.std(params_SO, axis=0), np.std(params_SOxP, axis=0), np.std(params_P, axis=0)
  std_SOmP = np.std(params_SO-params_P, axis=0)
  std_SOmSOxP = np.std(params_SO-params_SOxP, axis=0)
  std_SOpPm2SOxP = np.std(params_SO + params_P - 2*params_SOxP, axis=0)
  table = np.stack([np.mean(params_SO, axis=0),
                    np.mean(params_SOxP, axis=0),
                    np.mean(params_P, axis=0),
                    std_SO, std_SOxP, std_P,
                    std_SOmP, std_SOmSOxP, std_SOpPm2SOxP
  ])
  table = np.append(lines, table, axis=1)
  display(HTML(tabulate.tabulate(table, headers=labels, tablefmt="html")))
#+END_SRC

#+BEGIN_SRC ipython :session bcv :results raw drawer
  x = np.arange(5)
  plt.plot(x, 100*(1-std_P/std_SO)[:-1], "o", label="P")
  plt.plot(x, 100*(1-std_SOxP/std_SO)[:-1], "o", label="SOxP")
  plt.plot(x, 100*(1-std_SOmP/std_SO)[:-1], "o", label="SO-P")
  plt.plot(x, 100*(1-std_SOmSOxP/std_SO)[:-1], "o", label="SO-SOxP")
  plt.plot(x, 100*(1-std_SOpPm2SOxP/std_SO)[:-1], "o", label="SO+P-2SOxP")
  plt.ylabel(r"$\Delta_{\mathrm{/SO}}$ [\%]")
  plt.xticks(x, labels[:-1])
  plt.legend(loc="upper left", title=r"$\ell\in[50; 1500]$", bbox_to_anchor=(1,1))
#+END_SRC

#+RESULTS:
:results:
# Out[217]:
: <matplotlib.legend.Legend at 0x7f1eda8e5f98>
[[file:./obipy-resources/ODfucl.png]]
:end:

*** Org table                                                    :noexport:
#+BEGIN_SRC ipython :session bcv :results raw output
  print(tabulate.tabulate(table, headers=labels, tablefmt="orgtbl"))
#+END_SRC

#+RESULTS:
|                                | $\theta_\mathrm{MC}$ | $A_\mathrm{s}$ | $n_\mathrm{s}$ | $\Omega_\mathrm{b}h^2$ | $\Omega_\mathrm{c}h^2$ | $\chi^2/\mathrm{ndf}$ |
|--------------------------------+----------------------+----------------+----------------+------------------------+------------------------+-----------------------|
| $\mu$(SOxSO)                   |            0.0104164 |    2.12863e-09 |       0.965051 |              0.0221351 |               0.120983 |              0.742085 |
| $\mu$(SOxP)                    |            0.0104164 |    2.12875e-09 |        0.96499 |              0.0221342 |               0.121003 |              0.742216 |
| $\mu$(PxP)                     |            0.0104164 |    2.12881e-09 |       0.964953 |              0.0221335 |               0.121012 |              0.742351 |
| $\sigma$(SOxSO)                |           6.3324e-06 |    1.53135e-11 |     0.00712775 |            0.000258049 |             0.00282965 |             0.0280147 |
| $\sigma$(SOxP)                 |          6.34447e-06 |    1.52396e-11 |     0.00707853 |            0.000258622 |             0.00282214 |             0.0280142 |
| $\sigma$(PxP)                  |           6.5121e-06 |     1.5435e-11 |     0.00720973 |            0.000265144 |             0.00285634 |             0.0279847 |
| $\sigma$(SOxSO - PxP)          |           1.8413e-06 |    4.23132e-12 |      0.0021341 |            7.39349e-05 |            0.000775937 |            0.00875221 |
| $\sigma$(SOxSO - SOxP)         |          9.88702e-07 |    2.64955e-12 |     0.00126386 |            4.27381e-05 |            0.000495158 |            0.00443434 |
| $\sigma$(SOxSO + PxP - 2 SOxP) |          8.43566e-07 |     3.2112e-12 |     0.00141612 |            4.80235e-05 |            0.000617392 |            0.00245867 |
